---
title: "Modeling human serum albumin's association with survival among end-stage renal disease patients"
author: "J Steven Raquel"
        
mainfont: Times New Roman
sansfont: Times New Roman
output:
  html_document:
    toc: true
    toc_float: true
    includes:
      in_header: 
        header.html
geometry: "margin=1in"
fontsize: 12pt
csl: american-sociological-association.csl
header-includes:
  - \usepackage{setspace}
fig_width: 6
fig_height: 4        
        
        
navbar:
  title: "Home"
  left:
    - text: "About Me"
      href: about_me.html
    - text: "Resume"
      href: resume.html
    - text: "Projects"
      menu:
        - text: "Survival analysis of kidney disease patients"
          href: esrd-survival.html
        - text: "Spatial modeling of school gun violence"
          href: matern-spatial.html
        - text: "Sexual network exponential random graph modeling"
          href: ergm_models.html
        - text: "Classifying wine quality"
          href: wine-classification.html
        - text: "Forecasting bitcoin value"
          href: bitcoin.html
        - text: "Predicting housing prices"
          href: housing-prices.html
        - text: "Play Gomoku using Shiny"
          href: ggomoku.html
    - text: "Contact Me"
      menu:
        - text: "jsteven.raquel8@gmail.com"
          href: mailto:jsteven.raquel8@gmail.com
        - text: "GitHub"
          href: https://github.com/jstevenr
        - text: "LinkedIn"
          href: https://www.linkedin.com/in/jstevenr/
          
          
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, include = F)
library(survival)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggsurvfit)
library(tibble)
library(KMsurv)
library(survminer)
library(gtsummary)
library(Epi) # for nested case-control
library(knitr)
library(kableExtra)
library(gridExtra)

source("~/Workspace/stats255-w23/survival_functions.R")
# usrds_tvc <- read.csv(here::here("data", "usrds_tvc.csv")) %>% 
albumin <- read.csv(here::here("data", "LongitudinalAlbumin.csv"))
usrds <- read.csv(here::here("data",  "usrdsData.csv")) %>% 
  # changing factor variables to be more meaningful
  mutate(
    racegrp = case_when(
      racegrp == 1 ~ "White",
      racegrp == 2 ~ "Black",
      racegrp == 3 ~ "Other") %>% factor() %>% relevel("White"),
    smokegrp = case_when(
      smokegrp == 1 ~ "Never",
      smokegrp == 2 ~ "Former",
      smokegrp == 3 ~ "Current") %>% factor() %>% relevel("Never"),
    bmi_grp = case_when(
      bmi >= 18.5 & bmi < 25 ~ "Healthy", # deliberately setting healthy as baseline
      bmi < 18.5 ~ "Underweight",
      bmi >= 25 & bmi < 30 ~ "Overweight",
      bmi >= 30 ~ "Obese") %>% factor() %>% relevel("Healthy"),
    # creating group levels for continuous variables to test for confounding
    albumin0_hi = ifelse(albumin.0 >= median(albumin.0), 1, 0) %>% factor(),
    age_grp = cut(age, quantile(age, na.rm = T, 
                                probs = c(0, 0.33, 0.66, 1)),
                  include.lowest = TRUE),
    esrdtime_grp = cut(esrdtime, quantile(esrdtime, na.rm = T, 
                                          probs = c(0, 0.33, 0.66, 1)),
                       include.lowest = TRUE),
    cholest_grp = cut(cholest, quantile(cholest, na.rm = T, probs = c(0, 0.33, 0.66, 1)), 
                      include.lowest = TRUE),
    trigly_grp = cut(trigly, quantile(trigly, na.rm = T, probs = c(0, 0.33, 0.66, 1)),
                     include.lowest = TRUE),
    pstsbp_grp = cut(pst.sbp, quantile(pst.sbp, na.rm = T, probs = c(0, 0.33, 0.66, 1)),
                     include.lowest = TRUE),
    albumin0_grp = cut(albumin.0, quantile(albumin.0, probs = c(0, 0.33, 0.66, 1),
                                           na.rm = T), 
                       include.lowest = TRUE)
    ) %>% 
  mutate(across(.cols = c("female", "hist.cvd", "diabetes", "undnour"),
                .fns = factor, levels = c(0,1), labels = c("N", "Y")))

usrds_tvc <- read.csv(here::here("data", "usrds_tvc.csv")) %>% 
  mutate(racegrp = factor(racegrp) %>% relevel("White"),
         smokegrp = factor(smokegrp) %>% relevel("Never"),
         bmi_grp = factor(bmi_grp) %>% relevel("Healthy"))
```

```{r 2a-creating-dataset, eval = F}
# need to change the data to (start,stop)
# unique measure times for albumin
unique_ids <- unique(albumin$usrds.id)
n_ids <- length(unique_ids) # 1979

# left join the albumin data by id
usrds_tvc <- usrds %>% 
  merge(y = albumin, all.x = TRUE, by = "usrds.id") %>% 
  mutate(start = 0, stop = NA)

for (i in 1:n_ids) {

  message("Iteration ", i, " of ", n_ids)
  
  # subset to one id
  temp_df <- usrds_tvc %>% 
    filter(usrds.id == unique_ids[i])
  death_time <- unique(temp_df$tdeath) # death time for this subject
  # create start,stop windows
  stop_times <- c(temp_df$measday, death_time)[-1] # drop the leading 0
  temp_df$stop <- stop_times
  temp_df$start <- temp_df$measday
  
  # drop the old rows for this id temporarily
  usrds_tvc <- usrds_tvc %>% 
    filter(usrds.id != unique_ids[i])
  
  # add the new rows into the data
  usrds_tvc <- usrds_tvc %>%
    bind_rows(temp_df)

}

# writing to file
write.csv(usrds_tvc,
          "./final/usrds_tvc.csv",
          row.names = F)
```

# Abstract

In this study, we looked at data from 1979 hemodialysis patients in order to determine the risk factors for end-stage renal disease (ESRD), a condition which affects more than 850,000 individuals in the United States alone. Serum albumin, a blood protein which contributes to calcium levels in plasma, was recorded both at their entry into the study and at several follow-up periods throughout their time in their study. The model in which we treated albumin as static based on the subject's albumin level at the time of their entry into the study gave a coefficient estimate for albumin as $\exp(\hat \beta_1) \approx 0.649$ (95% CI: $[0.530, 0.818]$, p-value: $\approx 0.00016$). The model in which we also treated albumin as static based on its value at baseline, but included along with it an interaction term based on the subject's history of cardiovascular disease (or lack thereof), gave a coefficient estimate for albumin as $\exp(\hat \beta_1) \approx 0.491$ (95% CI: $[0.329, 0.732]$, p-value: $0.0005$), and a coefficient estimate for the interaction term as $\exp(\hat \beta_9) \approx 1.540$ (95% CI: $[0.964, 2.459]$, p-value: $\approx 0.071$). The model in which we treated albumin as a time-varying covariate based on the subject's albumin levels as recorded throughout their time in the study (with no interaction), gave a coefficient estimate for albumin as $\exp(\hat \beta_1) \approx 0.549$ (95% CI: $[0.485, 0.626]$, p-value: $\approx 0$). Finally, the model in which we treated album as a time-varying covariate as well as included an interaction term gave the respective estimates as $\exp( \hat \beta_1) \approx 0.369$ (95% CI: $[0.290, 0.469]$) for albumin, and $\exp (\hat \beta_9) \approx 1.738$ (95% CI: $[1.316, 2.295]$) for the interaction term. All models included race, whether the subject appeared undernourished, cholesterol, age, and diabetes as predictor variables, while treating body mass index and smoking history as confounding variables.

# Background / Introduction

End stage renal disease (ESRD) is a dangerous condition in which an individual's kidneys no longer adequately perform their function of filtering out toxins, and affects over 850 thousand individuals in the US alone. While most individuals who suffer from ESRD would ideally like to receive a kidney transplant, the other option is hemodialysis, which effectively performs the same function as one's kidneys. 

In the past it has been posited that protein biomarkers such as serum albumin may have an association with risk of death amongst hemodialysis patients, as human serum albumin is crucial in maintaining body nutrition, as it regulates the fluid exchange between various body parts, including blood circulation to the kidneys (Ha 2013). It also plays a role in metabolism. As such, it stands to reason that a lack of serum albumin would be linked with mortality among hemodialysis patients, whose kidneys are performing under below standards of healthiness. 

To test this hypothesis formally, this study was conducted based off of a sample of N = 1979 hemodialysis patients across the US who had undergone dialysis in December 2014. For all patients, serum albumin levels were recorded at the time of entry into the study, along with other demographic records including age, race, gender, body mass index (BMI), smoking history, a subjective assessment of nutritional status. Laboratory measurements on cholesterol, serum triglyceride, and post-dialysis systolic blood pressure measurements were also included. Serum albumin levels were also recorded repeatedly over time throughout the study, with records spaced between 1 to 2 months apart. 


# Methods

```{r missing-values}
usrds %>%
  select(!contains("_grp")) %>%  # ignoring the redundant factor columns
  summarise_all(~sum(is.na(.))) %>%
  t() %>%
  as.data.frame() %>%
  filter(V1 > 0) %>% 
  rename(NAs = V1) %>% 
  arrange(NAs %>% desc()) %>% 
  mutate(pct_missing = (NAs / nrow(usrds) * 100) %>% round(1))
```

## The Data

Our data consists of 1979 hemodialysis patients who were undergoing dialysis in December 2014 in dialysis clinics across the US. These patients' respective demographics vary across gender, race, as well as health history including body mass index (BMI), smoking history, history of cardiovascular disease (CVD), and diabetes. Measurements of nutritional status, such as levels of cholesterol, serum albumin, serum triglycerides, and post-dialysis systolic blood pressure were also recorded. Albumin, itself known to be a measure of healthiness on account of its role in filtering toxins from the body, was recorded consistently at periods between one to two months apart from one another, starting at the subject's entry into the study. Other variables recorded were a measure of the amount of time the subject had been affected by ESRD before entering the study, as well as an indicator for whether the study nurse noted the subject in question appeared undernourished at the time of data collection. 

While the sampling scheme is relatively sound in that we have a large random sample, one of the shortcoming of the study design is that there are also a large amount of missing records for certain variables, particularly serum triglycerides, which was missing in over 20% of records. It's also notable that we do not have clear information on the exact dates between albumin measurements, so we cannot state conclusively that two different subjects with similar serum albumin levels two time periods after baseline had the same amount of time between collections.

There are a number of ties--moments in time where more than one individual died--in the data. The method we used to account for this when fitting the model is the Efron approximation. A variety of different methodologies exist to deal with ties in survival analysis, but the Efron approximation offers a solid middle ground between the average partial likelihood and the decidedly inaccurate Breslow approximation, by weighting the partial likelihood by taking the average weight of the failures at time $t_j$.

## Confounders and Missing Data 

_Confounding variables_, or confounders, are variables which are causally associated with the predictor of interest and causally associated to the outcome of interest. Failing to account for confounders results in biased analyses and potentially misleading results. We tested formally for confounding variables first by following known causal pathways e.g. being overweight/obese is a risk factor for diabetes, so we suspected high BMI to be causally related to diabetes, knowing both are a risk factor for death. Then we conducted log-rank tests and Chi-squared tests for independence, establishing relationships between the outcome (death) and the predictor in question. 

We know a priori that smoking is associated with diabetes, which itself is associated with a higher risk of mortality. Nicotine and other chemicals in cigarettes affects insulin production, which can cause diabetes. Additionally, a high BMI (i.e. being overweight or obese) is a known risk factor for both death and diabetes. Both smoking and an unhealthy BMI are associated with a higher risk of mortality relative to non-smoking and a healthy BMI, hence we believe both of these variables make for potential confounders in our model. We were able to support these results through conducting individual log-rank tests both with and without stratifying on the respective confounder. 

```{r confounders, echo = T, include = T}
# smoking 
lr1 <- survdiff(Surv(tdeath, death) ~ diabetes, data = usrds) # fail to reject H0
lr2 <- survdiff(Surv(tdeath, death) ~ diabetes + strata(smokegrp), data = usrds) # reject H0
lr3 <- survdiff(Surv(tdeath, death) ~ diabetes + strata(bmi_grp), data = usrds) # reject H0
```

```{r confounders-table}
lr_tbl <- data.frame(
  model = c("Diabetes alone", 
            "Diabetes, stratified by smoking group",
            "Diabetes, stratified by BMI group"),
  p = c(lr1$pvalue, lr2$pvalue, lr3$pvalue) %>% round(3)
) 

lr_tbl %>%
    kbl(caption = "The respective p-values of the log-rank tests of the survival functions, testing the hypothesis that the survival curves are the same. Note that without stratification, diabetes is not significant at a 0.05 alpha level.") %>% 
  kable_styling(full_width = F, latex_option = "scale_down") 
```


Other potential confounders which we do not have data on but may still be relevant in terms of the research question are variables such as a history of drug use or a history of alcohol use. Alcohol and drug use have an adverse effect on the cardiovascular system (Gardner 2015), and poor heart health is associated with increased risk of mortality.

Also, of the 1979 subjects in the data, only 490 subjects had the failure event (death), while the remainder were _censored_, which is to say that they exited the study for reasons apart from the failure event, e.g. withdrawal, relocation, etc. We aren't explicitly aware of the circumstances of the censorship within this context, but one should be aware of the implications of censorship of results. One possible such reason for censoring is that the patient received a kidney transplant, recovered from ESRD, and longer needed to undergo dialysis, and exited the study as a result. These particular instances of censoring are considered right censoring.

## The Kaplan-Meier estimator

The first method used to quantify survival probability in survival analysis is the non-parametric Kaplan-Meier estimator. It is based on time $t_i$, where $i = 1, ..., N$, for $N$ time periods, $d_i$, the number of deaths at time $t$, and finally, $n$, the number of individuals at risk at time $t$. The group of individuals at risk, otherwise known as the risk set, are comprised of all individuals by that time point who have not experienced either the event of interest (death), were censored. 

The Kaplan-Meier estimate, $\hat S(t)$, is based on the product of all cases lower than or equal to time $t_i$, i.e.

$$\hat S(t) = \prod_{t_i < t} (1 - \frac{d_i}{n_i})$$

## The Cox proportional hazards

The Cox proportional hazards model is the method by which we fit models in order to estimate the _hazard rate_ $\lambda(t)$, which in continuous time is a conditional probability that during a very short interval $\Delta t$  the failure event will take place. THe hazard function is itself related to the survival function by the ratio $\lambda(t) = \frac{f(t)}{S(t)}$, where $f(t)$ is the the probability density function.

The general form of the Cox model is as follows

$$\lambda(t|\vec x_i) = \lambda_0 (t) \exp(\vec \beta_i^T \vec x_i)$$

where $\vec x_i$ is the vector of covariates for the $i$th subject, $\beta_i$ is the vector of coefficients, and $\lambda_0(t)$ is the baseline hazard function.

All analyses were conducted in R, most notably the `survival` package for its suite of functions for fitting survival curves and the Cox model. 

In order to determine which variables were appropriate for adding into the model, we employed the log-rank test, which compares the survival distribution of separate groups, in a manner similar to the Cochran-Mantel-Haenszel test, which itself considers a binary predictor to a binary outcome, groups them in strata and then compares the respective distributions to test the null hypothesis that there is no association between the predictor and the outcome. The log-rank test operates similarly in a manner such that the different strata are grouped by time $t$. 

Aside from fitting the model with baseline albumin, we were also interested in treating albumin as a time varying covariate, as we have data on albumin measurements for each subject throughout their time in the study, spaced about 1-2 months apart. The motivation behind this is to measure the effect of albumin on the risk of mortality across time.

The motive behind treating albumin alternatingly as a static and time varying covariate is to observe the different effect on the measured association between mortality and albumin level that stems from the two paradigms. Because a hemodialysis patient's albumin level is constantly in flux as the status of their health wavers, we believe that a model that incorporates that additional information would be more useful, rather than treating the albumin level at static to what its value is at baseline.

When adding continuous covariates into the model, we looked at plots of martingale residuals of Cox models vs standard OLS residuals were create (see Appendix) in order to determine ideal transformations. Neither the square-root transformation nor the log proved clearly ideal when transforming cholesterol as a variable, but nevertheless we opted to utilize the latter transformation. 

## Motivations for Our Model

Our primary goal was to measure the association between mortality (risk of death) and albumin, both at baseline and over time. We also wanted to measure the effect having a history of cardiovascular disease has on the association between mortality and albumin. As such, four different models were ultimately fit: 1) the model which treats serum albumin at baseline as constant (non-time varying), 2) the model which treats serum albumin at baseline as constant _and_ includes an interaction term between serum albumin and the subject's history of cardiovascular disease, 3) the model which treats serum albumin as a time-varying covariate, and finally 4) the model which treats serum albumin as a time-varying covariate as well as including the interaction term. 

The inclusion of an interaction term in the Cox model introduces a concept called _effect modification_, in which we hypothesize that some variable's association with the outcome (death) varies by different strata of another variable, known as the effect modifier. While confounding variables are superfluous and we correct for them to avoid incurring bias in our study, effect modifiers provide additional information and context on their covariates' supposed association with mortality. 

## Proportional Hazard Assumptions

In the following figure we are looking at the survival function between the aforementioned levels of albumin, but are also introducing a second covariate, this time with only two levels: history of cardiovascular disease. Immediately we can see that the golden curve, which corresponds to low baseline albumin and a history of cardiovascular disease, is starkly different from any other survival function. The top two curves, in green and blue, are those which correspond to subjects without a history of cardiovascular disease and had medium or high amounts of albumin at baseline, respectively. 

```{r km-baseline-albumin-cvd, echo = T,include = T}
# K-M survival estimate
survfit2(Surv(tdeath, death) ~ albumin0_grp + hist.cvd, data = usrds) %>% 
  ggsurvfit() +
  labs(
 x = "Days", 
 y = "Survival probability",
 title = "K-M estimates of groups of albumin at baseline and history of CVD",
 subtitle = "Groups were divided by 0-33%, 33-66%, and 66-100% percentiles.")

# cumulative hazard
survfit2(Surv(tdeath, death) ~ albumin0_grp + hist.cvd, data = usrds) %>% 
  ggsurvfit(type = "cumhaz") +
  labs(
 x = "Days", 
 y = "Cumulative hazard",
 title = "K-M estimates of groups of albumin at baseline and history of CVD",
 subtitle = "Groups were divided by 0-33%, 33-66%, and 66-100% percentiles.")
```

The cumulative hazard plot shows intersection between the blue, red, and pink curves, which represent the medium albumin/history of CVD, the low albumin/no history of CVD, and the high albumin/history of CVD groups respectively. Intersection/touching of hazard curves does give some evidence that the respective true hazard curves are not proportional to one another. A log-rank test of these groups testing the hypothesis that all of said curves are equal was rejected with a p-value of approximately 0 and a confidence level of 0.05.

Based on prior knowledge, scrutinizing survival curves, and conducting log-rank tests, we decided to include race, appearance of undernourishment, cholesterol, age, and diabetes as additional variables in the Cox model in addition to albumin. History of cardiovascular disease was included as an effect modification in two different models, while body mass index and smoking were both regarded as confounding variables, particularly with respect to their causal relationship with diabetes.

```{r fitting-models, echo = T, include = T}
coxph_1a <- coxph(Surv(tdeath, death) ~ 
                    albumin.0 + racegrp +
                    undnour + log(cholest) + age + 
                    diabetes +
                    strata(bmi_grp) +
                    strata(smokegrp), 
                  data = usrds)

# model with interaction between baseline albumin and cvd
coxph_1b <- coxph(Surv(tdeath, death) ~ 
                    albumin.0 + racegrp  +
                    undnour + log(cholest) + age + diabetes +
                    strata(bmi_grp) + strata(smokegrp) +
                    hist.cvd + albumin.0:hist.cvd, 
                  data = usrds)


# model with albumin as a time-varying covariate
coxph_2a <- coxph(Surv(start, stop, death) ~ 
                    albumin + racegrp + undnour + 
                    log(cholest) + age + diabetes +
                    strata(smokegrp) + strata(bmi_grp),
                    data = usrds_tvc)

# model with albumin as a time varying covariate + interaction with CVD
# with interaction with hist.cvd
coxph_2b <- coxph(Surv(start, stop, death) ~ 
                    albumin + racegrp + undnour + 
                    log(cholest) + age + diabetes +
                    strata(smokegrp) + strata(bmi_grp) +
                    hist.cvd + hist.cvd:albumin,
                  data = usrds_tvc)
```

```{r 2a-proportional-hazards, include = T}
test_2a <- cox.zph(coxph_2a, global = F)

test_2a_tbl <- test_2a$table %>% 
  as.data.frame() %>% 
  rownames_to_column() %>% 
  select(-c(df, chisq)) %>% 
  mutate(p = round(p, 3))
test_2a_tbl$rowname <- c("Albumin (over time)", "Race", "Appeared Undernourished",
                         "Log(Cholesterol)", "Age", "Diabetes")

colnames(test_2a_tbl) <- c("Covariate", "P-value")

test_2a_tbl %>%
  kbl(caption = "Testing whether the covariates in the model that includes albumin as a time-varying covariate also vary with time.") %>% 
kable_styling(full_width = F, latex_option = "scale_down") 
```

```{r 2b-proportional-hazards, include = T}
test_2b <- cox.zph(coxph_2b, global = F)

test_2b_tbl <- test_2b$table %>% 
  as.data.frame() %>% 
  rownames_to_column() %>% 
  select(-c(df, chisq)) %>% 
  mutate(p = round(p, 3))

test_2b_tbl$rowname <- c("Albumin (over time)", "Race", "Appeared Undernourished",
                         "Log(Cholesterol)", "Age", "Diabetes",
                         "History of CVD", "Albumin (over time) x History of CVD")

colnames(test_2b_tbl) <- c("Covariate", "P-value")

test_2b_tbl %>%
  kbl(caption = "Testing whether the covariates in the model that includes albumin as a time-varying covariate along with an interaction with a history of CVD, also vary with time.") %>% 
kable_styling(full_width = F, latex_option = "scale_down") 
```

Based on these tables above, we see that none of the covariates vary with time, apart from human serum albumin we know to treat as time-varying. This is due to the respective p-values of the chi-squared test where we compare the model that has the aforementioned covariate with an interaction with time, versus a nested model that does not have said interaction. All of these p-values are above our 0.05 significance level, so the Cox proportional hazards are not violated in this case.

# Results

## Interpretation of Parameter Estimates

### The baseline Albumin model

Our first model, which is principally concerned with the effect of albumin at baseline on the risk of mortality, is 

\begin{align*}
\lambda(t) = \ & \lambda_0(t) \exp(\beta_1 \text{albumin}_{t=0} + \beta_2 1_\text{race=Black} + \beta_3 1_\text{race=Other} + \\
& \beta_4 1_\text{\text{Undernourished=1}} + \beta_5 \log(\text{cholesterol}) + \beta_6 (\text{age}) + \beta_7 1_\text{Diabetes=1}
\end{align*}

```{r 1a-cox-model, include = T, echo = F}
# model with baseline albumin, no interaction
coxph_1a_sum <- summary(coxph_1a)
df_1a <- coxph_1a_sum$coefficients %>% 
  as.data.frame() 

rownames(df_1a) <- c("Albumin (at t=0)", 
                     "Race = Black", "Race = Other",
                     "Appeared Undernourished", 
                     "Log(Cholesterol)", "Age", "Diabetes")


colnames(df_1a) <- c("Coefficient", "exp(Coefficient)", 
                     "Standard Error", "Z-statistic", "P-value")

ci_1a <- coxph_1a_sum$conf.int %>% as.data.frame() %>%
  select(3:4)


df_1a <- df_1a %>% 
  select(c("Coefficient", "exp(Coefficient)", "P-value")) %>% 
  bind_cols(ci_1a) %>% 
  rename("Lower 95% CI" = 4, "Upper 95% CI" = 5) %>%
  relocate("P-value", .after = last_col()) 

df_1a %>% 
  round(3) %>% 
  kbl(caption = "Parameter estimates, CIs and p-values for the model with baseline serum albumin.") %>% 
kable_styling(full_width = F, latex_option = "scale_down") 
```


Based on $\exp(\hat{\beta_1}) \approx 0.659$, we estimate that the relative risk of death is approximately 34.1% lower when comparing the group which has a serum albumin value at baseline one-unit () higher than that of another group that has similar attributes with respect to race, whether they appeared undernourished to the study nurse, their cholesterol levels, their ages, and whether they have diabetes.

Based on $\exp(\hat{\beta_2}) \approx 0.757$, we estimate that the relative risk of death is approximately 24.3% lower when comparing the group of black individuals to the group of white individuals that are similar in their albumin levels, whether they appeared undernourished, their cholesterol levels, their ages, and whether they have diabetes.

Based on $\exp(\hat{\beta_3}) \approx 0.799$, we estimate that the relative risk of death is approximately 15.3% lower when comparing the group of individuals whose race is neither black nor white, to the group of white individuals that are similar in their albumin levels, whether they appeared undernourished, their cholesterol levels, their ages, and whether they have diabetes.

Based on $\exp(\hat{\beta_4}) \approx 2.036$, we estimate that the relative risk of death is approximately 2.036 times higher when comparing the group of individuals who appear undernourished to the study nurse to those who did not but are similar in their albumin levels, their race, their cholesterol levels, their ages, and whether they have diabetes.

Based on $\hat{\beta_5} \approx -0.431$, we estimate that comparing one group that has 10% higher cholesterol to another group with similar albumin levels, race, cholesterol levels, and ages is associated with a multiplicative difference of $1.10^{\hat \beta_5} \approx 0.96$, or a 4% lower relative risk of death.

Based on $\exp(\hat{\beta_6}) \approx 1.042$, we estimate that the relative risk of death is approximately 4.2% higher when comparing two groups that are 1 year apart in age, that are similar in terms of their albumin levels over time, whether they appear undernourished, their race, and their cholesterol levels.

Based on $\exp(\hat{\beta_7}) \approx 1.44$, we estimate that the relative risk of death is approximately 44% higher when comparing the group of individuals with diabetes to the group without diabetes, but with similar albumin levels, their race, cholesterol levels, whether they appear undernourished, and their age.

### The baseline Albumin model with CVD interaction

The second model introduced an interaction term for the effect of the subject's history of cardiovascular disease on the association between albumin level and risk of death.

\begin{align*}
\lambda(t) =\ & \lambda_0(t) \exp(\beta_1 \text{albumin}_{t=0} + \beta_2 1_\text{race=Black} + \beta_3 1_\text{race=Other} + \\
& \beta_4 1_\text{Undernourished=1} + \beta_5 \log(\text{cholesterol}) + \beta_6 (\text{age)} + \\ 
& \beta_7 1_\text{Diabetes=1} + \beta_8 1_\text{CVD=1} + \beta_9 (\text{albumin}_{t=0} \times 1_\text{CVD=1})
\end{align*}

```{r 1b-cox-model, include = T}
coxph_1b_sum <- summary(coxph_1b)
df_1b <- coxph_1b_sum$coefficients %>% 
  as.data.frame() 

rownames(df_1b) <- c("Albumin (at t=0)",
                     "Race = Black", "Race = Other",
                     "Appeared Undernourished", "Log(Cholesterol)",
                     "Age", "Diabetes",
                     "History of CVD", 
                     "Albumin (at t=0) x History of CVD")

colnames(df_1b) <- c("Coefficient", "exp(Coefficient)", 
                     "Standard Error", "Z-statistic", "P-value")

ci_1b <- coxph_1b_sum$conf.int %>% 
  as.data.frame() %>%
  select(3:4)


df_1b <- df_1b %>% 
  select(c("Coefficient", "exp(Coefficient)", "P-value")) %>% 
  bind_cols(ci_1b) %>% 
  rename("Lower 95% CI" = 4, "Upper 95% CI" = 5) %>%
  relocate("P-value", .after = last_col())

df_1b %>% 
  round(3) %>% 
  kbl(caption = "Parameter estimates, CIs and p-values for the model with baseline serum albumin and an interaction with history of CVD.") %>% 
kable_styling(full_width = F, latex_option = "scale_down") 
```

Based on $\exp(\hat{\beta_1}) \approx 0.491$, we estimate that the relative risk of death is approximately 50.9% lower when comparing the group which had a serum albumin value at baseline one-unit higher than that of another group that has similar attributes with respect to race, whether they appeared undernourished to the study nurse, their cholesterol levels, their ages, whether they have diabetes, and neither group has a history of cardiovascular disease.

Based on $\exp(\hat{\beta_2}) \approx 0.825$, we estimate that the relative risk of death is approximately 17.5% lower when comparing the group of black individuals to the group of white individuals that are similar in their albumin levels, whether they appeared undernourished, their cholesterol levels, their ages,  whether they have a history of cardiovascular disease, and whether they have diabetes.

Based on $\exp(\hat{\beta_3}) \approx 0.813$, we estimate that the relative risk of death is approximately 18.7% lower when comparing the group of individuals whose race is neither black nor white, to the group of white individuals that are similar in their albumin levels, whether they appeared undernourished, their cholesterol levels, their ages, whether they have a history of cardiovascular disease, and whether they have diabetes.

Based on $\exp(\hat{\beta_4}) \approx 1.988$, we estimate that the relative risk of death is approximately 1.988 times higher when comparing the group of individuals who appear undernourished to the study nurse to those who did not but are similar in their albumin levels, their race, their cholesterol levels, their ages, whether they have a history of cardiovascular disease, and whether they have diabetes.

Based on $\hat{\beta_5} \approx -0.479$, we estimate that comparing one group that has 10% higher cholesterol than another group with similar albumin levels, race, cholesterol levels, ages, whether they have diabetes, and history of cardiovascular disease is associated with a multiplicative difference of $1.10^{\hat \beta_5} \approx 0.955$ in the relative risk, or a 4.5% lower relative risk of death.

Based on $\exp(\hat{\beta_6}) \approx 1.034$, we estimate that the relative risk of death is approximately 3.4% higher when comparing two groups that are 1 year apart in age, that are similar in terms of their albumin levels over time, whether they appear undernourished, their race, their cholesterol levels, and whether they have diabetes.

Based on $\exp(\hat{\beta_7}) \approx 1.278$, we estimate that the relative risk of death is approximately 27.8% higher when comparing a group with diabetes to a group without, that are both similar in terms of their albumin levels over time, whether they appear undernourished, their race, their cholesterol levels, and their ages.

Based on $\exp(\hat{\beta_8}) \approx 0.458$, we estimate that the relative risk of death is approximately 54.2% lower when comparing the group that has a history of cardiovascular disease to the group that does not have a history of cardiovascular disease and is similar in terms of albumin levels, whether they appear undernourished, their race, their ages, their cholesterol levels, and whether they have diabetes.

Our estimate for the exponential of the interaction term is $\exp(\hat{\beta_9}) \approx 1.540$ If we were to compare two groups, both with a history of cardiovascular disease, and similar in terms of whether or not they appeared undernourished, in their race, their cholesterol levels, and their diabetes status, where one group would have their albumin at baseline as some fixed value, and the other group with their baseline albumin at some value 1 unit higher, the multiplicative difference in their relative risk of death would be approximately $\exp(\hat \beta_1 + \hat \beta_9) \approx 0.756$, i.e. their relative risk of death of the first group would be approximately 24.4% lower. It is also assumed we are adjusting for body mass index and smoking history as confounders. 

### The time-varying Albumin model

The third model treats albumin as a time-varying covariate.

\begin{align*} 
\lambda(t) = \ &\lambda_0(t) \exp(\beta_1 \text{albumin}_{t} + \beta_2 1_\text{race=Black} + \beta_3 1_\text{race=Other} + \\
& \beta_4 1_\text{Undernourished=1} + \beta_5 \log(\text{cholesterol}) + \beta_6 (\text{age} + \beta_7 1_\text{Diabetes=1}
\end{align*}

```{r 2a-model, include = T}
coxph_2a_sum <- summary(coxph_2a)

df_2a <- coxph_2a_sum$coefficients %>% 
  as.data.frame() 

rownames(df_2a) <- c("Albumin (over time)", 
                     "Race = Black", "Race = Other",
                     "Appeared Undernourished", "Log(Cholesterol)",
                     "Age", "Diabetes")

colnames(df_2a) <- c("Coefficient", "exp(Coefficient)", 
                     "Standard Error", "Z-statistic", "P-value")

ci_2a <- coxph_2a_sum$conf.int %>% as.data.frame() %>%
  select(3:4)


df_2a <- df_2a %>% 
  select(c("Coefficient", "exp(Coefficient)", "P-value")) %>% 
  bind_cols(ci_2a) %>% 
  rename("Lower 95% CI" = 4, "Upper 95% CI" = 5) %>%
  relocate("P-value", .after = last_col())

df_2a %>% 
  round(3) %>%
  kbl(caption = "Parameter estimates, CIs and p-values for the model with time-varying serum albumin.") %>%
  kable_styling(full_width = F, latex_option = "scale_down") 
```

Based on $\exp(\hat{\beta_1}) \approx 0.549$, we estimate that the relative risk of death is approximately 45.1% lower when comparing the group which has a serum albumin value one-unit higher than that of another group at the same period at which their albumin level was recorded; the groups also have similar attributes with respect to race, whether they appeared undernourished to the study nurse, their cholesterol levels, and their ages, 

Based on $\exp(\hat{\beta_2}) \approx 0.763$, we estimate that the relative risk of death is approximately 23.7% lower when comparing the group of black individuals to the group of white individuals that are similar in their albumin levels over time, whether they appeared undernourished, their cholesterol levels, their ages, and whether they have diabetes.

Based on $\exp(\hat{\beta_3}) \approx 0.857$, we estimate that the relative risk of death is approximately 14.3% lower when comparing the group of individuals whose race is neither black nor white, to the group of white individuals that are similar in their albumin levels over time, whether they appeared undernourished, their cholesterol levels, their ages, and whether they have diabetes.

Based on $\exp(\hat{\beta_4}) \approx 1.732$, we estimate that the relative risk of death is approximately 73.2% higher when comparing the group of individuals who appear undernourished to the study nurse to those who did not but are similar in their albumin levels over time, their race, their cholesterol levels, their ages, and whether they have diabetes.

Based on $\hat{\beta_5} \approx -0.172$, we estimate that comparing one group that has 10% higher cholesterol than another group with similar albumin levels over time, race, cholesterol levels, ages, and whether they have diabetes, is associated with a multiplicative difference of $1.10^{\hat \beta_5} \approx 0.984$, or a 1.6% lower relative risk of death.

Based on $\exp(\hat{\beta_6}) \approx 1.038$, we estimate that the relative risk of death is approximately 3.8% higher when comparing two groups that are 1 year apart in age, that are similar in terms of their albumin levels over time, whether they appear undernourished, their race, and their cholesterol levels.

Based on $\exp(\hat{\beta_7}) \approx 1.377$, we estimate that the relative risk of death is approximately 37.7% higher when comparing a group with diabetes to another group without, that are both similar in terms of their albumin levels over time, whether they appear undernourished, their race, their cholesterol levels, and their ages. 

### The time-varying Albumin model with CVD interaction

The fourth and final model treats albumin as a time-varying covariate and also includes an interaction term representing the effect of the subject's history of cardiovascular disease on the association between albumin level and risk of mortality. 

\begin{align*}
\lambda(t) =\ & \lambda_0(t) \exp(\beta_1 \text{albumin}_t + \beta_2 1_\text{race=Black} + \beta_3 1_\text{race=Other} + \\
& \beta_4 1_\text{Undernourished=1} + \beta_5 \log(\text{cholesterol}) + \beta_6 (\text{age} +  \\ 
& \beta_7 1_\text{Diabetes=1} + \beta_8 1_\text{CVD=1} + \beta_9 (\text{albumin}_{t=0} \times 1_\text{CVD=1})
\end{align*}

```{r 2b-model, include = T}
coxph_2b_sum <- summary(coxph_2b)

df_2b <- coxph_2b_sum$coefficients %>% 
  as.data.frame() 

rownames(df_2b) <- c("Albumin (over time)", 
                     "Race = Black", "Race = Other",
                     "Appeared Undernourished", "Log(Cholesterol)",
                     "Age", "Diabetes", "History of CVD",
                     "Albumin (over time) x History of CVD")

colnames(df_2b) <- c("Coefficient", "exp(Coefficient)", 
                     "Standard Error", "Z-statistic", "P-value")


ci_2b <- coxph_2b_sum$conf.int %>% as.data.frame() %>%
  select(3:4)


df_2b <- df_2b %>% 
  select(c("Coefficient", "exp(Coefficient)", "P-value")) %>% 
  bind_cols(ci_2b) %>% 
  rename("Lower 95% CI" = 4, "Upper 95% CI" = 5) %>%
  relocate("P-value", .after = last_col())

df_2b %>% 
  round(3) %>% 
  kbl(caption = "Parameter estimates, CIs and p-values for the model with time-varying serum albumin and an interaction with history of CVD.") %>% 
  kable_styling(full_width = F, latex_options="scale_down")
```


Based on $\exp(\hat{\beta_1}) \approx 0.369$, we estimate that the relative risk of death is approximately 63.1% lower when comparing the group which had a serum albumin value at baseline one-unit higher than that of another group that has similar attributes with respect to race, whether they appeared undernourished to the study nurse, their cholesterol levels, their ages, and neither group has cardiovascular disease.

Based on $\exp(\hat{\beta_2}) \approx 0.811$, we estimate that the relative risk of death is approximately 18.9% lower when comparing the group of black individuals to the group of white individuals that are similar in their albumin levels, whether they appeared undernourished, their cholesterol levels, their ages, whether they have a history of cardiovascular disease, and whether they have diabetes, while adjusting for body mass index and smoking history.

Based on $\exp(\hat{\beta_3}) \approx 0.822$, we estimate that the relative risk of death is approximately 17.8% lower when comparing the group of individuals whose race is neither black nor white, to the group of white individuals that are similar in their albumin levels, whether they appeared undernourished, their cholesterol levels, their ages, whether they have a history of cardiovascular disease, and whether they have diabetes, while adjusting for body mass index and smoking history.

Based on $\exp(\hat{\beta_4}) \approx 1.682$, we estimate that the relative risk of death is approximately 68.2% higher when comparing the group of individuals who appear undernourished to the study nurse to those who did not but are similar in their albumin levels, their race, their cholesterol levels, their ages, whether they have a history of cardiovascular disease, and whether they have diabetes, while adjusting for body mass index and smoking history.

Based on $\hat{\beta_5} \approx -0.231$, we estimate that comparing one group that has 10% higher cholesterol than another group with similar albumin levels, race, cholesterol levels, ages,  history of cardiovascular disease, and diabetes status (while adjusting for body mass index and smoking history) is associated with a multiplicative difference of $1.10^{\hat \beta_5} \approx 0.978$ in the relative risk, or a 2.2% lower relative risk of death.

Based on $\exp(\hat{\beta_6}) \approx 1.03$, we estimate that the relative risk of death is approximately 3% higher when comparing two groups that are 1 year apart in age, that are similar in terms of their albumin levels over time, whether they appear undernourished, their race, their cholesterol levels, and diabetes status, while adjusting for body mass index and smoking history.

Based on $\exp(\hat{\beta_7}) \approx 1.201$, we estimate that the relative risk of death is approximately 20.1% higher when comparing a group with diabetes to another group without, that are both similar in terms of their albumin levels over time, whether they appear undernourished, their race, their cholesterol levels, and their ages, while adjusting for body mass index and smoking history.

Based on $\exp(\hat{\beta_8}) \approx 0.286$, we estimate that the relative risk of death is approximately 71.4% lower when comparing the group that has a history of cardiovascular disease to the group that does not have a history of cardiovascular disease and is similar in terms of albumin levels, whether they appear undernourished, their race, their ages, their cholesterol levels, and their diabetes status, while adjusting for body mass index and smoking history.

Our estimate for the exponential of the interaction term is $\exp(\hat{\beta_9}) \approx 1.738$. If we were to compare two groups, both with a history of cardiovascular disease, and similar in terms of whether or not they appeared undernourished, in their race, and their cholesterol levels, where would have their albumin at baseline as some fixed value, and the other group with their baseline albumin at some value 1 unit higher, the multiplicative difference in their relative risk of death would be approximately $\exp(\hat \beta_1 + \hat \beta_9) \approx 0.628$, i.e. their relative risk of death of the first group would be approximately 37% lower. It is also assumed we are adjusting for body mass index and smoking history as confounders. 




# Discussion

Among all of the models fit, we believe the best among them to be that which treats albumin as a time-varying covariate as well as includes the effect modification term that reflects how having a history of cardiovascular disease affects the association between albumin and the relative risk of death. Overall, the results from all four models are reflective of our preliminary hypothesis which is that serum albumin is associated with mortality among ESRD patients, on account of it being a reflection of how healthy a person is. Notably, the interaction between serum albumin and history of CVD is significant at a 0.05 level when albumin is treated as time-varying. 

Many of the model coefficients for each covariate seemed relatively unchanged when going from model to model, with some exceptions. Notably, the effect of being of race "other" (neither black nor white) was seen as being associated with a lower relative risk of death in all but one of the models, the exception being the final model which included albumin as a time-varying covariate as well as the interaction with the history of CVD. The direction of the association of appearing undernourished was also inverted when going from having a positive association with the relative risk in the first three models to having a negative association.

Insofar as limitations of the study, there are certainly some shortcomings to consider, namely the lack of other confounding variables (such as drug use or alcohol use) being included in the data. Limiting the racial group category to a three-level factor variable also minimizes the extent to which we can quantify the effect race has on mortality with respect to albumin or other covariates in our model. Being that many minority groups are underrepresented in medical research despite their disproportionate amount of medical issues, this would be something to consider addressing going forward in future studies. 

One of the difficulties in the analysis was identifying an appropriate functional form for certain continuous covariates such as cholesterol. The efforts of trying to ascertain said functional form can be found in the Appendix. Many different transformations including the log transformation and the square root transformation were attempted but few seemed to cause an appreciable difference when looking at the martingale residuals of the Cox model free of cholesterol versus the standard residuals of the respective OLS model regressing all of the other covariates against cholesterol.

Future work should be dedicated to exploring more deeply the case-control study design and seeing what those outcomes would be relative to those compared here.

\newpage

# Appendix

```{r 3a-model, include = T, message = F, verbose = F, warning = F}
# create case-control data
usrds_3a <- ccwc(exit = tdeath, fail  = death, controls = 4,  
                 data = usrds,
                 include = list(albumin.0, racegrp, undnour, 
                                cholest, age, bmi_grp, smokegrp,
                                diabetes))

# coxph
coxph_3a <- coxph(Surv(Time, Fail) ~ 
                    albumin.0 + racegrp +
                    undnour + log(cholest) + age + diabetes +
                    strata(Set) + 
                    strata(bmi_grp) + strata(smokegrp),
                  data = usrds_3a)

# 3a model, baseline albumin, no interaction
fit_3a <- clogit(Fail ~ 
                   albumin.0 + racegrp + 
                   undnour + log(cholest) + age + diabetes +
                   strata(Set) +
                   strata(bmi_grp) + strata(smokegrp), 
                 data = usrds_3a)

sum_3a <- summary(fit_3a)

df_3a <- sum_3a$coefficients %>% as.data.frame()
df_3a <- df_3a %>% 
  select(1,2,5) %>% 
  rename("Coefficient" = 1, "exp(Coefficient)" = 2, "P-value" = 3)

rownames(df_3a) <- c("Albumin (at t=0)", 
                     "Race = Black", "Race = Other",
                     "Appeared Undernourished", "Log(Cholesterol)",
                     "Age", "Diabetes")

ci_3a <- sum_3a$conf.int %>% as.data.frame() %>% 
  select(3,4)

df_3a <- df_3a %>% 
  select(c("Coefficient", "exp(Coefficient)", "P-value")) %>% 
  bind_cols(ci_3a) %>% 
  rename("Lower 95% CI" = 4, "Upper 95% CI" = 5) %>%
  relocate("P-value", .after = last_col())

df_3a %>% 
  round(3) %>% 
  kbl(caption = "Parameter estimates, CIs and p-values for the nested case-control model.") %>%
kable_styling(full_width = F, latex_option = "scale_down")
```



```{r 3b-model, include = T, warning = F}
# create case-control data
usrds_3b <- ccwc(exit = tdeath, fail  = death, controls = 4,  
                 data = usrds,
                 include = list(albumin.0, hist.cvd, 
                                racegrp, undnour, 
                                cholest, age, bmi_grp, smokegrp,
                                diabetes))

# coxph
coxph_3b <- coxph(Surv(Time, Fail) ~ 
                    albumin.0 + racegrp +
                    undnour + log(cholest) + age + diabetes +
                    hist.cvd + hist.cvd:albumin.0 +
                    strata(Set) + 
                    strata(bmi_grp) + strata(smokegrp),
                  data = usrds_3b)

# 3b model, baseline albumin, no interaction
fit_3b <- clogit(Fail ~ 
                   albumin.0 + racegrp + 
                   undnour + log(cholest) + age + diabetes +
                   hist.cvd + hist.cvd:albumin.0 +
                   strata(Set) +
                   strata(bmi_grp) + strata(smokegrp), 
                 data = usrds_3b)

sum_3b <- summary(fit_3b)

df_3b <- sum_3b$coefficients %>% as.data.frame()
df_3b <- df_3b %>% 
  select(1,2,5) %>% 
  rename("Coefficient" = 1, "exp(Coefficient)" = 2, "P-value" = 3)

rownames(df_3b) <- c("Albumin (at t=0)", 
                     "Race = Black", "Race = Other",
                     "Appeared Undernourished", "Log(Cholesterol)",
                     "Age", "Diabetes", "History of CVD",
                     "Albumin (over time) x History of CVD")

ci_3b <- sum_3b$conf.int %>% as.data.frame() %>% 
  select(3,4)

df_3b <- df_3b %>% 
  select(c("Coefficient", "exp(Coefficient)", "P-value")) %>% 
  bind_cols(ci_3b) %>% 
  rename("Lower 95% CI" = 4, "Upper 95% CI" = 5) %>%
  relocate("P-value", .after = last_col())

df_3b %>% 
  round(3) %>% 
  kbl(caption = "Parameter estimates, CIs and p-values for the nested case-control model with an interaction.") %>%
kable_styling(full_width = F, latex_option = "scale_down")
```

```{r 2b-model-significance, include = T}
# this drops rows that are empty for hist.cvd so that we can do an LRT
coxph_2a2 <- coxph(Surv(start, stop, death) ~ 
                    albumin + racegrp + undnour + 
                    log(cholest) + age + diabetes +
                    strata(smokegrp) + strata(bmi_grp),
                    data = usrds_tvc %>% filter(!is.na(hist.cvd)))

# likelihood ratio test comparing full and nested model
# H0: the models fit the data equally well 
# reject H0, so interaction term is significant
lrt <- anova(coxph_2b, coxph_2a2)
lrt_df <- data.frame(chisq = lrt$Chisq[2], 
                     df = lrt$Df[2],
                     pval = lrt$`Pr(>|Chi|)`[2]) %>% 
  rename("LRT Test Statistic" = chisq,
         "Degrees of Freedom" = df,
         "P-value" = pval)
lrt_df %>% 
  kbl(caption = "Likelihood ratio test for comparing the model with the interaction to the one without.") %>% 
  kable_styling(full_width = F)
```

```{r log-rank-test, include = T}
# show that BMI is associated with both death and diabetes
# H0: no association
# reject H0
diabetes_sd1 <- survdiff(Surv(tdeath, death) ~ diabetes, data = usrds) # fail to reject H0 
diabetes_sd2 <- survdiff(Surv(tdeath, death) ~ diabetes + strata(bmi_grp), 
         data = usrds) # reject H0
diabetes_sd3 <- survdiff(Surv(tdeath, death) ~ diabetes + strata(smokegrp), 
         data = usrds) # fail to reject H0

bmi_chisq1 <- chisq.test(usrds[,"bmi_grp"], usrds[,"diabetes"]) # reject H0


df1 <- data.frame(Model = "Diabetes Only", 
                  p_val = diabetes_sd1$pvalue) %>% 
  add_row(Model = "Diabetes, stratified by BMI", 
          p_val = diabetes_sd2$pvalue) %>% 
  add_row(Model = "Diabetes, stratified by Smoking History",
          p_val = diabetes_sd3$pvalue)

df1 %>% 
  rename("Log-rank Test vs Death" = Model, "P-value" = p_val) %>% 
  kbl(caption = "The results of the log-rank test before and after stratifying by confounders BMI and smoking history. Without adjusting for the confounding variables, diabetes is not considered significantly associated with risk of death.") %>% 
  kable_styling(full_width = F, latex_options = "scale_down")
```

```{r diagnostics, include = F}
# red smooth line
# blue lm line

# delta beta residuals
ggcoxdiagnostics(coxph_1a, 
                 type = "dfbeta", 
                 linear.predictions = FALSE,
                 ggtheme = theme_bw(), hline = F, 
                 sline.se = F, sline.col = "red") +
  geom_smooth(method = "lm", formula = "y ~ x", se = F, col = "blue")

# deviance residuals
ggcoxdiagnostics(coxph_1a, 
                 type = "deviance",
                 linear.predictions = FALSE,
                 ggtheme = theme_bw(), hline = F, 
                 sline.se = F, sline.col = "red") +
  geom_smooth(method = "lm", formula = "y ~ x", se = F, col = "blue")
```

```{r plot-survival-curves, include = F}
# this plot shows there is not a statistically significant difference in survival between
# racegrp
survfit2(Surv(tdeath, death) ~ hist.cvd + albumin0_hi, 
         data = usrds) %>% 
  ggsurvfit() +
  labs(x = "Days", 
       y = "Survival probability")

# bmi
survfit2(Surv(tdeath, death) ~ bmi_grp, data = usrds) %>% 
  ggsurvfit() +
  labs(x = "Days", 
       y = "Overall survival probability",
       title = "Kaplan-Meier curves, by BMI group")

```

```{r functional-form-cholesterol, include = T}
# subsetting to needed columns and dropping NAs
usrds_chol <- usrds %>% 
       select(usrds.id, tdeath, death, albumin.0, racegrp, 
              smokegrp, bmi_grp, undnour, cholest) %>% 
       drop_na()

# fit the Cox model without age
fit_no_chol <- coxph(Surv(tdeath, death) ~ 
                       albumin.0 + racegrp + smokegrp + 
                       bmi_grp + undnour,
                     data = usrds_chol)

# do a regression fit with  cholesterol as the response vs the other predictors
lmfit_chol <- lm(cholest ~ albumin.0 + racegrp + smokegrp + 
                       bmi_grp + undnour,  
                 data = usrds_chol)

# sqrt
lmfit_chol_sqrt <- lm(sqrt(cholest) ~ albumin.0 + racegrp + smokegrp + 
                       bmi_grp + undnour,  
                 data = usrds_chol)
# log
lmfit_chol_log <- lm(log(cholest) ~ albumin.0 + racegrp + smokegrp + 
                       bmi_grp + undnour,  
                 data = usrds_chol)

# martingale residuals
mtgr_chol <- fit_no_chol %>% residuals(type = "martingale")
# standard residuals for both the sqrt and log transformations
stdr_chol <- lmfit_chol$residuals
stdr_chol_sqrt <- lmfit_chol_sqrt$residuals
stdr_chol_log <- lmfit_chol_log$residuals

# creating data.frame
df_chol <- data.frame(
  id = usrds_chol$usrds.id,
  mtg_resid = mtgr_chol,
  std_resid = stdr_chol,
  std_resid_sqrt = stdr_chol_sqrt,
  std_resid_log = stdr_chol_log) 

# now plot the residuals against each other
# no transformation for chol
plot_chol <- df_chol %>% 
  arrange(std_resid) %>% 
  ggplot(aes(x = std_resid, y = mtg_resid)) +
  geom_point() +
  scale_y_continuous(limits = c(-2,2)) +
  geom_smooth(method = "loess", formula = 'y ~ x',
              linetype = "dashed", color = "red", se = F) +
  geom_smooth(method = "lm", formula = 'y ~ x',
              linetype = "solid", color = "blue", se = F) +
  labs(title = "Martingale Residuals vs Standard Residuals, Cholesterol",
       x = "Standard Residuals",
       y = "Martingale Residuals") 

# square root transformation
plot_chol_sqrt <- df_chol %>% 
  arrange(std_resid_sqrt) %>% 
  ggplot(aes(x = std_resid_sqrt, y = mtg_resid)) +
  geom_point() +
  scale_y_continuous(limits = c(-2,2)) +
  geom_smooth(method = "loess", formula = 'y ~ x',
              linetype = "dashed", color = "red", se = F) +
  geom_smooth(method = "lm", formula = 'y ~ x',
              linetype = "solid", color = "blue", se = F) +
  labs(title = "Martingale Residuals vs Standard Residuals of sqrt(chol), Cholesterol",
       x = "Standard Residuals",
       y = "Martingale Residuals") 
# best option appears to be log

# log transformation
plot_chol_log <- df_chol %>% 
  arrange(std_resid_log) %>% 
  ggplot(aes(x = std_resid_log, y = mtg_resid)) +
  geom_point() +
  scale_y_continuous(limits = c(-2,2)) +
  geom_smooth(method = "loess", formula = 'y ~ x',
              linetype = "dashed", color = "red", se = F) +
  geom_smooth(method = "lm", formula = 'y ~ x',
              linetype = "solid", color = "blue", se = F) +
  labs(title = "Martingale Residuals vs Standard Residuals of log(chol), Cholesterol",
       x = "Standard Residuals",
       y = "Martingale Residuals") 
```

```{r functional-form-chol}
grid.arrange(plot_chol,
             plot_chol_log,
             plot_chol_sqrt, ncol = 1)

```

```{r functional-form-trigly, include = F}
# subsetting to needed columns and dropping NAs
usrds_trigly <- usrds %>% 
       select(usrds.id, tdeath, death, albumin.0, racegrp, 
              smokegrp, bmi_grp, undnour, age, cholest, trigly) %>% 
       drop_na()

# fit the Cox model without age
fit_no_trigly <- coxph(Surv(tdeath, death) ~ 
                       albumin.0 + racegrp + smokegrp + 
                       bmi_grp + undnour + age,
                     data = usrds_trigly)

# do a regression fit with  cholesterol as the response vs the other predictors
lmfit_trigly <- lm(trigly ~ 
                     albumin.0 + racegrp + smokegrp + 
                     bmi_grp + undnour + age,  
                 data = usrds_trigly)

# sqrt
lmfit_trigly_sqrt <- lm(sqrt(trigly) ~ albumin.0 + racegrp + smokegrp + 
                       bmi_grp + undnour + age,  
                 data = usrds_trigly)
# log
lmfit_trigly_log <- lm(log(trigly) ~ albumin.0 + racegrp + smokegrp + 
                       bmi_grp + undnour + age,  
                 data = usrds_trigly)

# martingale residuals
mtgr_trigly <- fit_no_trigly %>% residuals(type = "martingale")
# standard residuals for both the sqrt and log transformations
stdr_trigly <- lmfit_trigly$residuals
stdr_trigly_sqrt <- lmfit_trigly_sqrt$residuals
stdr_trigly_log <- lmfit_trigly_log$residuals

# creating data.frame
df_trigly <- data.frame(
  id = usrds_trigly$usrds.id,
  mtg_resid = mtgr_trigly,
  std_resid = stdr_trigly,
  std_resid_sqrt = stdr_trigly_sqrt,
  std_resid_log = stdr_trigly_log) 

# now plot the residuals against each other
# no transformation for chol
df_trigly %>% 
  arrange(std_resid) %>% 
  ggplot(aes(x = std_resid, y = mtg_resid)) +
  geom_point() +
  scale_y_continuous(limits = c(-2,2)) +
  geom_smooth(method = "loess", formula = "y ~ x",
              linetype = "dashed", color = "red", se = F) +
  geom_smooth(method = "lm", formula = "y ~ x",
              linetype = "solid", color = "blue", se = F) +
  labs(title = "Martingale Residuals vs Standard Residuals, Triglycerides",
       x = "Standard Residuals",
       y = "Martingale Residuals") 

# square root transformation
df_trigly %>% 
  arrange(std_resid_sqrt) %>% 
  ggplot(aes(x = std_resid_sqrt, y = mtg_resid)) +
  geom_point() +
  scale_y_continuous(limits = c(-2,2)) +
  geom_smooth(method = "loess", formula = "y ~ x",
              linetype = "dashed", color = "red", se = F) +
  geom_smooth(method = "lm", formula = "y ~ x",
              linetype = "solid", color = "blue", se = F) +
  labs(title = "Martingale Residuals vs Standard Residuals of sqrt(trigly), Triglycerides",
       x = "Standard Residuals",
       y = "Martingale Residuals") 

# log transformation
df_trigly %>% 
  arrange(std_resid_log) %>% 
  ggplot(aes(x = std_resid_log, y = mtg_resid)) +
  geom_point() +
  scale_y_continuous(limits = c(-2,2)) +
  geom_smooth(method = "loess", formula = "y ~ x",
              linetype = "dashed", color = "red", se = F) +
  geom_smooth(method = "lm", formula = "y ~ x",
              linetype = "solid", color = "blue", se = F) +
  labs(title = "Martingale Residuals vs Standard Residuals of log(trigly), Triglycerides",
       x = "Standard Residuals",
       y = "Martingale Residuals") 
# best option appears to be log
```

```{r functional-form-age, include = F}
# subsetting to needed columns and dropping NAs
usrds_age <- usrds %>% 
       select(usrds.id, tdeath, death, albumin.0, racegrp, 
              smokegrp, bmi_grp, undnour, cholest, trigly, age, age) %>% 
       drop_na()

# fit the Cox model without age
fit_no_age <- coxph(Surv(tdeath, death) ~ 
                       albumin.0 + racegrp + smokegrp + 
                       bmi_grp + undnour + log(cholest),
                     data = usrds_age)

# do a regression fit with  cholesterol as the response vs the other predictors
lmfit_age <- lm(age ~ albumin.0 + racegrp + smokegrp + 
                       bmi_grp + undnour + log(cholest),  
                 data = usrds_age)

# sqrt
lmfit_age_sqrt <- lm(sqrt(age) ~ albumin.0 + racegrp + smokegrp + 
                       bmi_grp + undnour + log(cholest),  
                 data = usrds_age)
# log
lmfit_age_log <- lm(log(age) ~ albumin.0 + racegrp + smokegrp + 
                       bmi_grp + undnour + log(cholest),  
                 data = usrds_age)

# squared
lmfit_age_sq <- lm(age^2 ~ albumin.0 + racegrp + smokegrp + 
                       bmi_grp + undnour + log(cholest),  
                 data = usrds_age)

# martingale residuals
mtgr_age <- fit_no_age %>% residuals(type = "martingale")
# standard residuals for both the sqrt and log transformations
stdr_age <- lmfit_age$residuals
stdr_age_sqrt <- lmfit_age_sqrt$residuals
stdr_age_log <- lmfit_age_log$residuals
stdr_age_sq <- lmfit_age_sq$residuals

# creating data.frame
df_age <- data.frame(
  id = usrds_age$usrds.id,
  mtg_resid = mtgr_age,
  std_resid = stdr_age,
  std_resid_sqrt = stdr_age_sqrt,
  std_resid_log = stdr_age_log,
  std_resid_sq = stdr_age_sq) 

# now plot the residuals against each other
df_age %>% 
  arrange(std_resid) %>% 
  ggplot(aes(x = std_resid, y = mtg_resid)) +
  geom_point() +
  scale_y_continuous(limits = c(-2,2)) +
  geom_smooth(method = "loess", formula = 'y ~ x',
              linetype = "dashed", color = "red", se = F) +
  geom_smooth(method = "lm", formula = 'y ~ x',
              linetype = "solid", color = "blue", se = F) +
  labs(title = "Martingale Residuals vs Standard Residuals, Age",
       x = "Standard Residuals",
       y = "Martingale Residuals") 

df_age %>% 
  arrange(std_resid_sqrt) %>% 
  ggplot(aes(x = std_resid_sqrt, y = mtg_resid)) +
  geom_point() +
  scale_y_continuous(limits = c(-2,2)) +
  geom_smooth(method = "loess", formula = 'y ~ x',
              linetype = "dashed", color = "red", se = F) +
  geom_smooth(method = "lm", formula = 'y ~ x',
              linetype = "solid", color = "blue", se = F) +
  labs(title = "Martingale Residuals vs Standard Residuals of sqrt(Age), Cholesterol",
       x = "Standard Residuals",
       y = "Martingale Residuals") 

# log model
# now plot the residuals against each other
df_age %>% 
  arrange(std_resid_log) %>% 
  ggplot(aes(x = std_resid_log, y = mtg_resid)) +
  geom_point() +
  scale_y_continuous(limits = c(-2,2)) +
  geom_smooth(method = "loess", formula = 'y ~ x', 
              linetype = "dashed", color = "red", se = F) +
  geom_smooth(method = "lm", formula = 'y ~ x', 
              linetype = "solid", color = "blue", se = F) +
  labs(title = "Martingale Residuals vs Standard Residuals of log(Age)",
       x = "Standard Residuals",
       y = "Martingale Residuals")

df_age %>% 
  arrange(std_resid_sq) %>% 
  ggplot(aes(x = std_resid_sq, y = mtg_resid)) +
  geom_point() +
  scale_y_continuous(limits = c(-2,2)) +
  geom_smooth(method = "loess", formula = 'y ~ x',
              linetype = "dashed", color = "red", se = F) +
  geom_smooth(method = "lm", formula = 'y ~ x',
              linetype = "solid", color = "blue", se = F) +
  labs(title = "Martingale Residuals vs Standard Residuals, Age",
       x = "Standard Residuals",
       y = "Martingale Residuals") 
# best option appears to be log
```

```{r log-rank-tests-1a}
# H0: The two groups have identical hazard functions

# the base variables
logrank_alb0 <- survdiff(Surv(tdeath, death) ~ albumin0_hi, data = usrds) # reject H0
logrank_cvd <- survdiff(Surv(tdeath, death) ~ hist.cvd, data = usrds) # reject H0
logrank_alb0_cvd <- survdiff(Surv(tdeath, death) ~ albumin0_hi + hist.cvd, data = usrds) # reject H0

# the variables we want to add
logrank_race <- survdiff(Surv(tdeath, death) ~ racegrp, data = usrds) # reject H0
logrank_pstsbp <- survdiff(Surv(tdeath, death) ~ pstsbp_grp, data = usrds) # reject H0 
logrank_smoke <- survdiff(Surv(tdeath, death) ~ smokegrp, data = usrds) # reject H0
logrank_age <- survdiff(Surv(tdeath, death) ~ age_grp, data = usrds) # reject H0
logrank_bmi <- survdiff(Surv(tdeath, death) ~ bmi_grp, data = usrds) # reject H0
logrank_undnour <- survdiff(Surv(tdeath, death) ~ undnour, data = usrds) # reject H0
logrank_cholest <- survdiff(Surv(tdeath, death) ~ cholest_grp, data = usrds) # reject H0

logrank_bmi

# the variables we will not add
logrank_trigly <- survdiff(Surv(tdeath, death) ~ trigly_grp, data = usrds) # fail to reject H0
logrank_esrd <- survdiff(Surv(tdeath, death) ~ esrdtime_grp, data = usrds) # fail to reject H0
logrank_gender <- survdiff(Surv(tdeath, death) ~ female, data = usrds) # fail to reject H0
```

```{r 1a-check-confounders}
# chi.sq test to check association between death and other variables

options(scipen=5) # turn off scientific notation

# categorical covariates
categories <- usrds %>% 
  select(contains("grp"), "female", "diabetes", "undnour", "hist.cvd") %>% 
  colnames() # 13

list <- list()
for (i in 1:length(categories)) {
  
  # get one variable
  var1 <- categories[i]
  # get all other variables
  other_vars <- categories[-i]
  
  # create a data.frame
  df <- matrix(ncol = 8, nrow = length(other_vars)) %>% 
    as.data.frame() %>% 
    rename(var1 = 1, var2 = 2, 
           chisq_pval = 3, chisq_reject = 6, # chi-squared test
           sd_pval = 4, sd_reject = 7, # log-rank test (no strafying)
           strata_pval = 5, strata_reject = 8) # log-rank test (w/ strata)
  
  df$var1 <- var1
  df$var2 <- other_vars
  
  # filling data.frame with p-values
  for (j in 1:length(other_vars)) {
    
    var2 <- other_vars[j]
    
    # get vector of the values
    var1_vec <- usrds[,var1]
    var2_vec <- usrds[,var2]

    # H0: var1 and var2 are not associated
    chisq <- chisq.test(table(var1_vec, var2_vec))      
    df$chisq_pval[df$var2 == var2] <- chisq$p.value %>% round(3)
    df$chisq_reject[df$var2 == var2] <- chisq$p.value < 0.05
    
    # creating a version of the dataset that actually has var1 and var2
    # so I can call them in survdiff
    usrds_tmp <- usrds %>%
      select(all_of(c(var1, var2)), tdeath, death) %>% 
      rename(var1 = 1, var2 = 2)
    
    # H0: hazard function is the same for all levels of var1
    # testing if hazard curves are the same between levels of var1
    sd <- survdiff(Surv(tdeath, death) ~ var1, data = usrds_tmp)
    df$sd_pval <- sd$pvalue %>% round(3)
    df$sd_reject <- sd$pvalue < 0.05
    
    # H0: hazard function is the same for all levels of var1 when adjusting for var2
    strata <- survdiff(Surv(tdeath, death) ~ var1 + strata(var2), 
                        data = usrds_tmp)
    df$strata_pval[df$var2 == var2] <- strata$pvalue %>% round(3)
    df$strata_reject[df$var2 == var2] <- strata$pvalue < 0.05
    
  } # for loop
  # store data.frame in the list
  
  list[[i]] <- df %>% 
    # label as potential founder if var1 and var2 are associated AND
    # if the log-rank test does not agree with the stratified log-rank test
    mutate(confound = ifelse(chisq_reject == TRUE & 
                               (sd_reject != strata_reject),
                             yes = TRUE, no = FALSE))
}

names(list) <- categories

# confounders : 
list2 <- list()
for (i in 1:length(list)) {
  
  list2[[i]] <- list[[i]] %>% 
    filter(confound == TRUE)
}

names(list2) <- categories
list2<- list2 %>% vctrs::list_drop_empty()

# an association with mortality
# an association with the other covariate
# stratifying on bmi changes the conclusion of the log-rank test for both smoking and diabetes

# chisq_pval - from chisq.test(var1, var2)
# sd_pval - from log-rank test of death vs var1
# strata_pval from stratifying log rank test of death vs var1 + strata(var2)
list2

# turn sceintific notation back on
options(scipen=0)

```

```{r data-checking}
# check for ties
sum(duplicated(usrds$tdeath[usrds$death == 1])) # 217
# method = "" in coxph() to deal with the ties
# efron, breslow, exact
```

```{r 1a-confounders}
# stratifying log-rank tests
# base model
# at least one group is different with respect to survival
survdiff(Surv(tdeath, death) ~ albumin0_grp, data = usrds) # reject H0

## gender (not a confounder)

# check for association between gender and mortality (outcome)
# H0: no association between gender and mortality

# check for association between gender and albumin0_grp (predictor)
survdiff(Surv(tdeath, death) ~ albumin0_grp + strata(female), data = usrds) # reject H0

## racegrp

survdiff(Surv(tdeath, death) ~ albumin0_grp + strata(racegrp), data = usrds) # reject H0
# not a confounder
## diabetes

survdiff(Surv(tdeath, death) ~ diabetes, data = usrds)
survdiff(Surv(tdeath, death) ~ albumin0_grp + strata(diabetes), data = usrds) # reject H0
# not a confounder
## smokegrp

survdiff(Surv(tdeath, death) ~ albumin0_grp + strata(smokegrp), data = usrds) # reject H0
## 

# age group
# reject H0 (p-value approx 0)
# H0: no association between age and mortality

# age has an association with mortality
# it is not on the causal pathway between albumin and mortality
# H0: those with high albumin/history of cvd have the same mortality rate than those who do not, adjusting for age
# reject H0; they have the same mortality rate when adjusting for age
survdiff(Surv(tdeath, death) ~ albumin0_grp + strata(age_grp), data = usrds) # reject H0
# reject H0 even after adjusting for age
# hence age is not a confounding variable. this is the same result

#### bmi group
# reject H0, p-value approx 0
# H0: no association between group and mortality
survdiff(Surv(tdeath, death) ~ pstsbp_grp, data = usrds) # reject H0 
survdiff(Surv(tdeath, death) ~ hist.cvd, data = usrds) # reject H0
survdiff(Surv(tdeath, death) ~ female, data = usrds) # fail to reject H0
survdiff(Surv(tdeath, death) ~ racegrp, data = usrds) # reject H0
survdiff(Surv(tdeath, death) ~ smokegrp, data = usrds) # reject H0
survdiff(Surv(tdeath, death) ~ age_grp, data = usrds) # reject H0
survdiff(Surv(tdeath, death) ~ bmi_grp, data = usrds) # reject H0
survdiff(Surv(tdeath, death) ~ undnour, data = usrds) # reject H0
survdiff(Surv(tdeath, death) ~ trigly_grp, data = usrds) # fail to reject H0
survdiff(Surv(tdeath, death) ~ cholest_grp, data = usrds) # reject H0
survdiff(Surv(tdeath, death) ~ esrdtime_grp, data = usrds) # fail to reject H0
survdiff(Surv(tdeath, death) ~ pstsbp_grp, data = usrds) # reject H0

# so BMI and death are associated
# H0: those with high albumin have the same mortality rate than those who do not, adjusting for BMI level
survdiff(Surv(tdeath, death) ~ albumin0_grp + strata(bmi_grp), data = usrds) # reject H0
# relationship holds even after adjusting for BMI
# so BMI is not a confounding variable

# whether they appeared undernourished

# H0: those with a history of CVD have the same mortality rate than those who do not, adjusting for appearing undernourished
# reject H0
survdiff(Surv(tdeath, death) ~ albumin0_grp + strata(undnour), data = usrds) 
# relationship holds after adjusting for undernourishment

# time with ESRD
# reject H0 (p-value = 0.002)

  
# H0: those with a history of CVD have the same mortality rate than those who do not, adjusting for BMI level
# reject H0
survdiff(Surv(tdeath, death) ~ albumin0_grp + strata(esrdtime_grp), data = usrds) 

# cholesterol
# H0: no association between mortality and cholesterol levels

survdiff(Surv(tdeath, death) ~ albumin0_grp + strata(cholest_grp), data = usrds) # reject H0
# cholesterol is not a confounding variable

# triglycerides
# H0: no association between mortality and triglyceride levels

survfit2(Surv(tdeath, death) ~ trigly_grp, data = usrds) %>% 
  ggsurvfit() +
  labs(x = "Days", 
       y = "Overall survival probability",
       title = "Kaplan-Meier survival estimate of triglyceride groups")

# reject H0
survdiff(Surv(tdeath, death) ~ albumin0_grp + strata(trigly_grp), data = usrds) # reject H0
# triglyceride groups are not a confounding variable

# post systolic blood pressure

survdiff(Surv(tdeath, death) ~ albumin0_grp + strata(pstsbp_grp), data = usrds) # reject H0
# post systolic blood pressure is not a confounding variable
```

```{r density-plot-baseline-albumin}
# density plot of baseline albumin
usrds %>% 
  ggplot(aes(x = albumin.0)) +
  geom_density(fill = "blue", alpha = 0.5) +
  theme_bw() +
  ggtitle("Density plot of Albumin at Baseline")
```

```{r overall-survival-curve, include = F}
km <- survfit2(Surv(tdeath, death) ~ 1, data = usrds) 

ggsurvfit(km) +
  labs(x = "Days",
       y = "Overall survival probability"
  ) +
  add_confidence_interval() +
  add_risktable()


ggsurvfit(km, type = "cumhaz") +
  labs(x = "Days",
       y = "Overall survival probability"
  ) +
  add_confidence_interval() +
  add_risktable()

```

```{r distribution-of-death}
usrds %>% 
  mutate(death = factor(death, levels = c(1,0), labels = c("death", "censored"))) %>% 
  ggplot(aes(x = death)) +
  geom_bar() +
  labs(title = "Distribution of Death and Censored")
```

```{r survfit-baseline-albumin-binary, include = T}
# K-M plot comparing high vs low baseline albumin
albumin0_survfit <- survfit2(Surv(tdeath, death) ~ albumin0_grp + hist.cvd, data = usrds)

albumin0_survfit %>% 
  tbl_survfit(
    times = 365.25,
    label_header = "**1-year survival (95% CI)**"
  )

# kaplan-meier estimate plot
ggsurvfit(albumin0_survfit) +
  labs(x = "Days", 
       y = "Overall survival probability",
       title = "Kaplan-Meier survival estimate of high vs low albumin at baseline")

# cumulative hazard plot comparing high vs low baseline albumin
ggsurvfit(albumin0_survfit, type = "cumhaz") +
  labs(x = "Days", 
       y = "Overall survival probability",
       title = "Cumulative hazard estimate of high vs low albumin at baseline") +
  add_confidence_interval()
```


```{r survfit-cvd}
# K-M plot comparing high vs low baseline albumin
cvd_survfit <- 
  survfit2(
    Surv(tdeath, death) ~ hist.cvd,
    data = usrds %>% 
      mutate(hist.cvd = factor(hist.cvd, levels = c("Y","N"), 
                               labels = c("yes", "no"))))

cvd_survfit %>% 
  tbl_survfit(
    times = 365.25,
    label_header = "**1-year survival (95% CI)**"
  )

# kaplan-meier estimate plot
ggsurvfit(cvd_survfit) +
  labs(x = "Days", 
       y = "Overall survival probability",
       title = "Kaplan-Meier survival estimate comparing w/ and w/o cardiovascular disease history") +
  add_confidence_interval()
```

```{r exploratory-plots, include = F}

# bar plot of cardiovascular disease vs 
usrds %>% 
  filter(!is.na(hist.cvd)) %>% # drop empty rows
  mutate(hist.cvd = factor(hist.cvd, 
                        levels = c(1, 0), labels = c("yes", "no")),
         albumin0_hi = factor(albumin0_hi, 
                              levels = c(1,0), labels = c("yes", "no"))
         ) %>% 
  ggplot(aes(x = hist.cvd, fill = albumin0_hi)) +
  geom_bar(stat = "count", position = position_dodge()) + 
  labs(title = "Distribution of baseline albumin, by history of CVD",
       x = "History of Cardiovascular Disease",
       caption = "161 subjects had missing information.")

# gender (female/male) vs death
usrds %>% 
  filter(!is.na(female)) %>% # drop empty rows
  mutate(gender = factor(female, 
                        levels = c(1, 0), labels = c("female", "male")),
         death = factor(death, levels = c(1,0), labels = c("death", "censored"))) %>% 
  ggplot(aes(x = gender, group = death, color = death, fill = death)) +
  geom_bar(stat = "count", position = position_dodge())

# race vs death
usrds %>% 
  filter(!is.na(racegrp)) %>% # drop empty rows %>% 
  mutate(death = factor(death, levels = c(1,0), labels = c("death", "censored"))) %>% 
  ggplot(aes(x = racegrp, group = death, color = death, fill = death)) +
  geom_bar(stat = "count", position = position_dodge())

# smokegrp vs death
usrds %>% 
  filter(!is.na(smokegrp)) %>% 
  mutate(death = factor(death, levels = c(1,0), labels = c("death", "censored"))) %>% 
  ggplot(aes(x = smokegrp, group = death, color = death, fill = death)) +
  geom_bar(stat = "count", position = position_dodge())

# under-nourished
usrds %>% 
  filter(!is.na(undnour)) %>% 
  mutate(undnour = factor(undnour, levels = c(1,0), labels = c("yes", "no"))) %>% 
  mutate(death = factor(death, levels = c(1,0), labels = c("death", "censored"))) %>% 
  ggplot(aes(x = undnour, group = death, color = death, fill = death)) +
  geom_bar(stat = "count", position = position_dodge())

# bmi (underweight)
usrds %>% 
  filter(!is.na(bmi_grp)) %>% 
  mutate(death = factor(death, levels = c(1,0), labels = c("death", "censored"))) %>% 
  ggplot(aes(x = bmi_grp, group = death, color = death, fill = death)) +
  geom_bar(stat = "count", position = position_dodge())

# density plot of baseline albumin
usrds %>% 
  ggplot(aes(x = albumin.0)) + 
  geom_density(fill = "lightblue")
```


\newpage

# References

Chung-Eun Ha, Nadhipuram V. Bhagavan,
Novel insights into the pleiotropic effects of human serum albumin in health and disease,
Biochimica et Biophysica Acta (BBA) - General Subjects,
Volume 1830, Issue 12,
2013,
Pages 5486-5493,
ISSN 0304-4165,
https://doi.org/10.1016/j.bbagen.2013.04.012.

Gardner JD, Mouton AJ. Alcohol effects on cardiac function. Compr Physiol. 2015 Apr;5(2):791-802. doi: 10.1002/cphy.c140046. PMID: 25880513.
